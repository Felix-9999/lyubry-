{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst dns_1 = __importDefault(require(\"dns\"));\nconst tls_1 = __importDefault(require(\"tls\"));\nconst url_1 = __importDefault(require(\"url\"));\nconst debug_1 = __importDefault(require(\"debug\"));\nconst agent_base_1 = require(\"agent-base\");\nconst socks_1 = require(\"socks\");\nconst debug = debug_1.default('socks-proxy-agent');\nfunction dnsLookup(host) {\n  return new Promise((resolve, reject) => {\n    dns_1.default.lookup(host, (err, res) => {\n      if (err) {\n        reject(err);\n      } else {\n        resolve(res);\n      }\n    });\n  });\n}\nfunction parseSocksProxy(opts) {\n  let port = 0;\n  let lookup = false;\n  let type = 5;\n  // Prefer `hostname` over `host`, because of `url.parse()`\n  const host = opts.hostname || opts.host;\n  if (!host) {\n    throw new TypeError('No \"host\"');\n  }\n  if (typeof opts.port === 'number') {\n    port = opts.port;\n  } else if (typeof opts.port === 'string') {\n    port = parseInt(opts.port, 10);\n  }\n  // From RFC 1928, Section 3: https://tools.ietf.org/html/rfc1928#section-3\n  // \"The SOCKS service is conventionally located on TCP port 1080\"\n  if (!port) {\n    port = 1080;\n  }\n  // figure out if we want socks v4 or v5, based on the \"protocol\" used.\n  // Defaults to 5.\n  if (opts.protocol) {\n    switch (opts.protocol.replace(':', '')) {\n      case 'socks4':\n        lookup = true;\n      // pass through\n      case 'socks4a':\n        type = 4;\n        break;\n      case 'socks5':\n        lookup = true;\n      // pass through\n      case 'socks': // no version specified, default to 5h\n      case 'socks5h':\n        type = 5;\n        break;\n      default:\n        throw new TypeError(`A \"socks\" protocol must be specified! Got: ${opts.protocol}`);\n    }\n  }\n  if (typeof opts.type !== 'undefined') {\n    if (opts.type === 4 || opts.type === 5) {\n      type = opts.type;\n    } else {\n      throw new TypeError(`\"type\" must be 4 or 5, got: ${opts.type}`);\n    }\n  }\n  const proxy = {\n    host,\n    port,\n    type\n  };\n  let userId = opts.userId || opts.username;\n  let password = opts.password;\n  if (opts.auth) {\n    const auth = opts.auth.split(':');\n    userId = auth[0];\n    password = auth[1];\n  }\n  if (userId) {\n    Object.defineProperty(proxy, 'userId', {\n      value: userId,\n      enumerable: false\n    });\n  }\n  if (password) {\n    Object.defineProperty(proxy, 'password', {\n      value: password,\n      enumerable: false\n    });\n  }\n  return {\n    lookup,\n    proxy\n  };\n}\n/**\n * The `SocksProxyAgent`.\n *\n * @api public\n */\nclass SocksProxyAgent extends agent_base_1.Agent {\n  constructor(_opts) {\n    let opts;\n    if (typeof _opts === 'string') {\n      opts = url_1.default.parse(_opts);\n    } else {\n      opts = _opts;\n    }\n    if (!opts) {\n      throw new TypeError('a SOCKS proxy server `host` and `port` must be specified!');\n    }\n    super(opts);\n    const parsedProxy = parseSocksProxy(opts);\n    this.lookup = parsedProxy.lookup;\n    this.proxy = parsedProxy.proxy;\n    this.tlsConnectionOptions = opts.tls || {};\n  }\n  /**\n   * Initiates a SOCKS connection to the specified SOCKS proxy server,\n   * which in turn connects to the specified remote host and port.\n   *\n   * @api protected\n   */\n  callback(req, opts) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        lookup,\n        proxy\n      } = this;\n      let {\n        host,\n        port,\n        timeout\n      } = opts;\n      if (!host) {\n        throw new Error('No `host` defined!');\n      }\n      if (lookup) {\n        // Client-side DNS resolution for \"4\" and \"5\" socks proxy versions.\n        host = yield dnsLookup(host);\n      }\n      const socksOpts = {\n        proxy,\n        destination: {\n          host,\n          port\n        },\n        command: 'connect',\n        timeout\n      };\n      debug('Creating socks proxy connection: %o', socksOpts);\n      const {\n        socket\n      } = yield socks_1.SocksClient.createConnection(socksOpts);\n      debug('Successfully created socks proxy connection');\n      if (opts.secureEndpoint) {\n        // The proxy is connecting to a TLS server, so upgrade\n        // this socket connection to a TLS connection.\n        debug('Upgrading socket connection to TLS');\n        const servername = opts.servername || opts.host;\n        return tls_1.default.connect(Object.assign(Object.assign(Object.assign({}, omit(opts, 'host', 'hostname', 'path', 'port')), {\n          socket,\n          servername\n        }), this.tlsConnectionOptions));\n      }\n      return socket;\n    });\n  }\n}\nexports.default = SocksProxyAgent;\nfunction omit(obj, ...keys) {\n  const ret = {};\n  let key;\n  for (key in obj) {\n    if (!keys.includes(key)) {\n      ret[key] = obj[key];\n    }\n  }\n  return ret;\n}","map":{"version":3,"names":["dns_1","__importDefault","require","tls_1","url_1","debug_1","agent_base_1","socks_1","debug","default","dnsLookup","host","Promise","resolve","reject","lookup","err","res","parseSocksProxy","opts","port","type","hostname","TypeError","parseInt","protocol","replace","proxy","userId","username","password","auth","split","Object","defineProperty","value","enumerable","SocksProxyAgent","Agent","constructor","_opts","parse","parsedProxy","tlsConnectionOptions","tls","callback","req","timeout","Error","socksOpts","destination","command","socket","SocksClient","createConnection","secureEndpoint","servername","connect","assign","omit","exports","obj","keys","ret","key","includes"],"sources":["../src/agent.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}